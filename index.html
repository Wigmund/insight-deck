<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Insight Deck Explorer</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=1.15">
</head>
<body>

    <header>
        <h1>The Insight Deck</h1>
        <nav>
            <a href="#actions">Actions</a>            
            <a href="#heroes">Heroes</a>
            <a href="#archetypes">Archetypes</a>
        </nav>
    </header>

    <main class="container">
        <section id="introduction">
            <h2>Welcome to The Insight Deck</h2>
            <p>The Insight Deck is a unique 78-card system designed to illuminate individual and team strengths, reveal potential shadows, and spark meaningful conversations for growth. Inspired by the timeless wisdom of Tarot, this deck translates archetypal energies and everyday dynamics into actionable insights.</p>
            </br><p>Explore the three core categories of cards:</p>
            <ul>
                <li><strong>Action Cards</strong></br>Everyday behaviors and approaches, highlighting the impact of their expression.</li>
                <li><strong>Hero Cards</strong></br>Actionable tools and mindsets to navigate challenges and leverage strengths.</li>
                <li><strong>Archetype Cards</strong></br>Powerful personas representing core strengths and their inherent shadows.</li>                
            </ul>
            </br><p>All card types are divided into four 'suits', each representing a fundamental element:</p>
            <ul>
                <li><strong>Fire</strong></br>Fire represents action, initiative, creativity, and the drive to make things happen. It fuels momentum, inspires boldness, and sparks transformation across all aspects of growth.</li>
                <li><strong>Water</strong></br>Water embodies connection, emotional intelligence, and the power of relationships. It nurtures collaboration, empathy, and a harmonious environment for individuals and teams.</li>
                <li><strong>Air</strong></br>Air signifies clarity, strategy, and communication. It brings insight, critical thinking, and the ability to navigate challenges with thoughtful planning and perspective.</li>                
                <li><strong>Earth</strong></br>Earth stands for execution, resources, and practical achievement. It grounds ideas in reality, supports skillful action, and ensures that intentions lead to tangible results.</li>                
            </ul>
            </br><p>Whether you're an individual seeking self-understanding, a coach facilitating growth, or a team aiming for greater synergy, The Insight Deck offers a creative and engaging way to unlock deeper awareness and foster positive change.</p>
        </section>

        <!-- Deck Theme Section -->
        <section id="deck-theme">
            <h2>Deck Theme</h2>
            <p>Personalize your Insight Deck experience by selecting a theme. Themes allow you to tailor the look and feel of your cards, making the deck uniquely yours or aligned with your team's culture. Choose a theme from the dropdown below to see how your cards can be transformed!</p>
            <select id="theme-select">
                <option value="">Loading themes...</option>
            </select>
            <div id="deck-carousel" class="deck-carousel">
                <!-- Carousel cards will be rendered here -->
            </div>
        </section>

        <section id="actions">
            <h2>The Action Cards</h2>
            <p>The 40 Action cards focus on practical behaviors, skills, and methods that individuals and teams use to navigate everyday work situations.</p>

            <h3 class="suit-title fire">FIRE - Action & Initiative</h3>
            <p class="card-group-subtitle">Embodies proactivity, energy, creativity and leadership.</p>
            <div class="card-gallery" id="fire-action-gallery">
                <!-- Fire Action cards will be populated here -->
            </div>

            <h3 class="suit-title water">WATER - Connection & Culture</h3>
            <p class="card-group-subtitle">Embodies relationships, emotional intelligence, collaboration and team environment.</p>
            <div class="card-gallery" id="water-action-gallery">
                <!-- Water Action cards will be populated here -->
            </div>

            <h3 class="suit-title air">AIR - Clarity & Strategy</h3>
            <p class="card-group-subtitle">Embodies critical thinking, planning, communication, decision-making and facing challenges.</p>
            <div class="card-gallery" id="air-action-gallery">
                <!-- Air Action cards will be populated here -->
            </div>

            <h3 class="suit-title earth">EARTH - Execution & Resources</h3>
            <p class="card-group-subtitle">Embodies practical application, skills, resources and tangible outcomes.</p>
            <div class="card-gallery" id="earth-action-gallery">
                <!-- Earth Action cards will be populated here -->
            </div>
        </section>

        <section id="heroes">
            <h2>The Hero Cards</h2>
            <p>The 16 Hero cards offer powerful tools, methods and mindsets to help individuals and teams navigate challenges, leverage associated Actions and embody their Archetypal strengths more effectively.</p>

            <h3 class="suit-title fire">FIRE - Action & Initiative</h3>
            <p class="card-group-subtitle">Tools that can spark bold action, energize teams and ignite creative momentum.</p>
            <div class="card-gallery" id="fire-hero-gallery">
                <!-- Fire Hero cards will be populated here -->
            </div>

            <h3 class="suit-title water">WATER - Connection & Culture</h3>
            <p class="card-group-subtitle">Tools that can deepen relationships, nurture emotional intelligence and foster a collaborative culture.</p>
            <div class="card-gallery" id="water-hero-gallery">
                <!-- Water Hero cards will be populated here -->
            </div>

            <h3 class="suit-title air">AIR - Clarity & Strategy</h3>
            <p class="card-group-subtitle">Tools that can clarify thinking, guide strategic decisions and enhance communication.</p>
            <div class="card-gallery" id="air-hero-gallery">
                <!-- Air Hero cards will be populated here -->
            </div>

            <h3 class="suit-title earth">EARTH - Execution & Resources</h3>
            <p class="card-group-subtitle">Tools that can ground ideas in practical steps, manage resources and ensure tangible results.</p>
            <div class="card-gallery" id="earth-hero-gallery">
                <!-- Earth Hero cards will be populated here -->
            </div>
        </section>

        <section id="archetypes">
            <h2>The Archetype Cards</h2>
            <p>The 22 Archetype cards represent fundamental patterns of being, core strengths and significant approaches one might embody. Each Archetype carries inherent wisdom and power, but also potential 'shadows'.</p>

            <h3 class="suit-title fire">FIRE - Action & Initiative</h3>
            <p class="card-group-subtitle">Personas that embody boldness, creativity and the drive to initiate and inspire action.</p>
            <div class="card-gallery" id="fire-archetype-gallery">
                <!-- Fire Archetype cards will be populated here -->
            </div>

            <h3 class="suit-title water">WATER - Connection & Culture</h3>
            <p class="card-group-subtitle">Personas that foster empathy, nurture relationships and cultivate a harmonious team culture.</p>
            <div class="card-gallery" id="water-archetype-gallery">
                <!-- Water Archetype cards will be populated here -->
            </div>

            <h3 class="suit-title air">AIR - Clarity & Strategy</h3>
            <p class="card-group-subtitle">Personas that bring insight, strategic thinking and clear communication to guide direction.</p>
            <div class="card-gallery" id="air-archetype-gallery">
                <!-- Air Archetype cards will be populated here -->
            </div>

            <h3 class="suit-title earth">EARTH - Execution & Resources</h3>
            <p class="card-group-subtitle">Personas that ground ideas in reality, manage resources wisely and ensure practical outcomes.</p>
            <div class="card-gallery" id="earth-archetype-gallery">
                <!-- Earth Archetype cards will be populated here -->
            </div>
        </section>

        <section id="admin">
            <button id="reset-modified-button" class="reset-button">Reset Modification Flags</button>
        </section>
    </main>

    <footer>
        <p>Â© 2025 The Insight Deck. All Rights Reserved.</p>
    </footer>

    <!-- Modal for Card Details -->
    <div id="cardModal" class="modal">
        <div id="cardContent" class="modal-content">
            <div class="modal-header-flex">
                <span id="card-details-suit" class="suit-mark material-icons"></span>
                <div class="modal-type-stack">
                    <span id="card-detail-type"></span>
                    <span id="card-detail-number"></span>
                </div>
            </div>
            <div class="modal-buttons">
                <span id="save-button" class="modal-button material-icons">save</span>
                <span id="close-button" class="modal-button material-icons">close</span>
            </div>
            <div id="card-detail-title" class="editable-field" contenteditable="true" data-field="title" placeholder="Enter title here..."></div>
            <div id="card-detail-description" class="editable-field" contenteditable="true" data-field="description" placeholder="Enter description here..."></div>
            <div id="card-detail-content">
                <div class="tabs">
                    <!-- Tabs will be dynamically created here -->
                </div>
                <div class="tab-content">
                    <!-- Tab content will be dynamically displayed here -->
                </div>
            </div>
        </div>
    </div>

<div id="carousel-modal" style="display:none;">
    <div id="carousel-modal-backdrop" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(30,30,30,0.7);z-index:2000;"></div>
    <div id="carousel-modal-content" style="position:fixed;z-index:2001;display:flex;align-items:center;justify-content:center;top:0;left:0;width:100vw;height:100vh;">
        <!-- Card will be injected here -->
        <button id="carousel-modal-close" aria-label="Close" style="position:absolute;top:24px;right:36px;font-size:2.2rem;background:rgba(255,255,255,0.5);border:none;border-radius:50%;width:44px;height:44px;cursor:pointer;z-index:10;">&times;</button>
    </div>
</div>

<script type="module">
    import { saveCardToFirebase, getCardsFromFirebase } from './firebase.js';
    import { getThemesFromFirebase } from './firebase.js';

    document.addEventListener('DOMContentLoaded', () => {
        let cardsData = [];
        let themesData = [];
        let selectedTheme = null;

        // Load Cards from Firebase
        loadCards();

        const modal = document.getElementById('cardModal');
        const modalType = document.getElementById('card-detail-type');
        const modalNumber = document.getElementById('card-detail-number');
        const modalSuit = document.getElementById('card-details-suit');
        const modalTitle = document.getElementById('card-detail-title');
        const modalDescription = document.getElementById('card-detail-description');
        const modalContent = document.getElementById('card-detail-content');
        const saveButton = document.getElementById('save-button');
        const closeButton = document.getElementById('close-button');

        // Add suit mark using a dictionary for icon mapping
        const suitIcons = {
            fire: 'local_fire_department',
            water: 'water_drop',
            air: 'air',
            earth: 'public'
        };
        
        // Function to load cards from Firebase
        async function loadCards() {
            try {
                cardsData = await getCardsFromFirebase();

                populateGalleries();
                renderCarousel(cardsData);
            } catch (error) {
                console.error('Error loading cards from Firebase:', error);
            }
        }

        // Load Themes from Firebase and populate dropdown
        loadThemes();

        // Carousel DOM references
        const carousel = document.getElementById('deck-carousel');
        const themeSelect = document.getElementById('theme-select');

        // Carousel modal elements
        const carouselModal = document.getElementById('carousel-modal');
        const carouselModalContent = document.getElementById('carousel-modal-content');
        const carouselModalClose = document.getElementById('carousel-modal-close');
        const carouselModalBackdrop = document.getElementById('carousel-modal-backdrop');

        async function loadThemes() {
            try {
                themesData = await getThemesFromFirebase();
                themeSelect.innerHTML = '';
                if (themesData.length === 0) {
                    themeSelect.innerHTML = '<option value="">No themes found</option>';
                } else {
                    themesData.forEach((theme, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx; // Use index for easy lookup
                        opt.textContent = theme.name;
                        themeSelect.appendChild(opt);
                    });
                }
                // Set selectedTheme to the first theme by default if available
                if (themesData.length > 0) {
                    selectedTheme = themesData[0];
                    themeSelect.selectedIndex = 0;
                    renderCarousel(cardsData); // Ensure carousel uses the theme on load
                }
            } catch (error) {
                themeSelect.innerHTML = '<option value="">Error loading themes</option>';
                console.error('Error loading themes:', error);
            }
        }

        // Listen for theme selection changes
        themeSelect.addEventListener('change', () => {
            const idx = themeSelect.value;
            selectedTheme = themesData[idx] || null;
            renderCarousel(cardsData);
        });

        // Render carousel cards
        function renderCarousel(cards) {
            carousel.innerHTML = '';
            cards.forEach((card, idx) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'carousel-card';
                cardDiv.setAttribute('data-idx', idx);
                // Set background color based on selected theme and card suit
                if (selectedTheme && selectedTheme.background_color && card.suit) {
                    const bg = selectedTheme.background_color[card.suit];
                    if (bg) cardDiv.style.background = bg;
                }
                cardDiv.textContent = card.title;
                // Click to expand
                cardDiv.addEventListener('click', () => openCarouselModal(card, cardDiv));
                carousel.appendChild(cardDiv);
            });
        }

        let originalCardParent = null;
        let originalCardNextSibling = null;
        let isCarouselModalOpen = false; // Prevent double open
        let currentModalCardDiv = null; // Track the card in modal

        function openCarouselModal(card, cardDiv) {
            if (isCarouselModalOpen) return; // Prevent re-entry
            isCarouselModalOpen = true;
            currentModalCardDiv = cardDiv;

            // Remove any previous card from modal
            const prev = carouselModalContent.querySelector('.carousel-card');
            if (prev) prev.remove();

            // Save original parent and next sibling for restoration
            originalCardParent = cardDiv.parentNode;
            originalCardNextSibling = cardDiv.nextSibling;

            // Remove click handler while in modal
            cardDiv._originalClickHandler = cardDiv.onclick;
            cardDiv.onclick = null;
            cardDiv.style.pointerEvents = 'none';

            // Get original position and size BEFORE moving
            const rect = cardDiv.getBoundingClientRect();
            const originalWidth = rect.width;
            const originalHeight = rect.height;

            // Move the cardDiv into the modal content
            carouselModalContent.appendChild(cardDiv);

            // Show modal (so modalCard gets correct size)
            carouselModal.style.display = 'block';

            // Calculate scale to fit modal (max 90vw x 80vh)
            const maxWidth = Math.min(window.innerWidth * 0.9, 350);
            const maxHeight = Math.min(window.innerHeight * 0.8, 630);
            const scaleX = maxWidth / originalWidth;
            const scaleY = maxHeight / originalHeight;
            const scale = Math.min(scaleX, scaleY);

            // Set fixed size and prevent flexbox stretching
            cardDiv.style.width = originalWidth + 'px';
            cardDiv.style.height = originalHeight + 'px';
            cardDiv.style.minWidth = '0';
            cardDiv.style.minHeight = '0';
            cardDiv.style.maxWidth = 'none';
            cardDiv.style.maxHeight = 'none';
            cardDiv.style.position = 'relative';
            cardDiv.style.zIndex = '10';
            cardDiv.style.left = '0';
            cardDiv.style.top = '0';
            cardDiv.style.margin = '0 auto';
            cardDiv.style.transition = 'transform 0.35s cubic-bezier(.4,2,.3,1)';
            cardDiv.style.transformOrigin = 'center center';

            // Start at scale(1), then scale up
            cardDiv.style.transform = 'scale(1)';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    cardDiv.style.transform = `scale(${scale})`;
                });
            });

            document.body.style.overflow = 'hidden';
        }

        function closeCarouselModal() {
            if (!isCarouselModalOpen) return;
            isCarouselModalOpen = false;
            const cardDiv = currentModalCardDiv || carouselModalContent.querySelector('.carousel-card');
            if (cardDiv && originalCardParent) {
                // Remove transform and transition
                cardDiv.style.transform = '';
                cardDiv.style.transition = '';
                cardDiv.style.position = '';
                cardDiv.style.zIndex = '';
                cardDiv.style.left = '';
                cardDiv.style.top = '';
                cardDiv.style.margin = '';
                cardDiv.style.transformOrigin = '';
                cardDiv.style.pointerEvents = '';
                cardDiv.style.width = '';
                cardDiv.style.height = '';
                cardDiv.style.minWidth = '';
                cardDiv.style.minHeight = '';
                cardDiv.style.maxWidth = '';
                cardDiv.style.maxHeight = '';
                // Restore click handler if needed
                if (cardDiv._originalClickHandler) {
                    cardDiv.onclick = cardDiv._originalClickHandler;
                    delete cardDiv._originalClickHandler;
                }
                // Move card back to its original parent and position
                if (originalCardNextSibling) {
                    originalCardParent.insertBefore(cardDiv, originalCardNextSibling);
                } else {
                    originalCardParent.appendChild(cardDiv);
                }
            }
            carouselModal.style.display = 'none';
            document.body.style.overflow = '';
            originalCardParent = null;
            originalCardNextSibling = null;
            currentModalCardDiv = null;
        }

        // Attach close handlers for carousel modal
        carouselModalClose.addEventListener('click', closeCarouselModal);
        carouselModalBackdrop.addEventListener('click', closeCarouselModal);

        // Function to populate galleries with card previews
        function populateGalleries() {
            const fireActionGallery = document.getElementById('fire-action-gallery');
            const waterActionGallery = document.getElementById('water-action-gallery');
            const airActionGallery = document.getElementById('air-action-gallery');
            const earthActionGallery = document.getElementById('earth-action-gallery');
            
            const fireHeroGallery = document.getElementById('fire-hero-gallery');
            const waterHeroGallery = document.getElementById('water-hero-gallery');
            const airHeroGallery = document.getElementById('air-hero-gallery');
            const earthHeroGallery = document.getElementById('earth-hero-gallery');

            const fireArchetypeGallery = document.getElementById('fire-archetype-gallery');
            const waterArchetypeGallery = document.getElementById('water-archetype-gallery');
            const airArchetypeGallery = document.getElementById('air-archetype-gallery');
            const earthArchetypeGallery = document.getElementById('earth-archetype-gallery');

            // Clear existing galleries
            fireActionGallery.innerHTML = '';
            waterActionGallery.innerHTML = '';
            airActionGallery.innerHTML = '';
            earthActionGallery.innerHTML = '';
            fireHeroGallery.innerHTML = '';
            waterHeroGallery.innerHTML = '';
            airHeroGallery.innerHTML = '';
            earthHeroGallery.innerHTML = '';
            fireArchetypeGallery.innerHTML = '';
            waterArchetypeGallery.innerHTML = '';
            airArchetypeGallery.innerHTML = '';
            earthArchetypeGallery.innerHTML = '';

            // Populate galleries with cards
            cardsData.forEach(card => {
                const cardPreview = createCardPreview(card);
                if (card.type === 'action') {
                    if (card.suit === 'fire') fireActionGallery.appendChild(cardPreview);
                    else if (card.suit === 'water') waterActionGallery.appendChild(cardPreview);
                    else if (card.suit === 'air') airActionGallery.appendChild(cardPreview);
                    else if (card.suit === 'earth') earthActionGallery.appendChild(cardPreview);
                } else if (card.type === 'hero') {
                    if (card.suit === 'fire') fireHeroGallery.appendChild(cardPreview);
                    else if (card.suit === 'water') waterHeroGallery.appendChild(cardPreview);
                    else if (card.suit === 'air') airHeroGallery.appendChild(cardPreview);
                    else if (card.suit === 'earth') earthHeroGallery.appendChild(cardPreview);
                } else if (card.type === 'archetype') {
                    if (card.suit === 'fire') fireArchetypeGallery.appendChild(cardPreview);
                    else if (card.suit === 'water') waterArchetypeGallery.appendChild(cardPreview);
                    else if (card.suit === 'air') airArchetypeGallery.appendChild(cardPreview);
                    else if (card.suit === 'earth') earthArchetypeGallery.appendChild(cardPreview);
                }
            });
        }

        // Function to create a card preview element
        function createCardPreview(card) {
            const cardDiv = document.createElement('div');
            cardDiv.classList.add('card-preview');
            cardDiv.setAttribute('data-id', card.id);
            cardDiv.setAttribute('data-type', card.type);
            cardDiv.setAttribute('data-suit', card.suit);

            // Add green tick mark if the card is modified
            if (card.isModified) {
                const tickMark = document.createElement('span');
                tickMark.classList.add('tick-mark', 'material-icons');
                tickMark.textContent = 'task_alt';
                cardDiv.appendChild(tickMark);
            }

            // Add suit mark
            const suitMark = document.createElement('span');
            suitMark.classList.add('suit-mark', 'material-icons');
            suitMark.textContent = suitIcons[card.suit];
            cardDiv.appendChild(suitMark);

            // Add number mark
            const numberMark = document.createElement('span');
            numberMark.classList.add('number-mark');
            numberMark.textContent = String(card.number).toUpperCase();
            cardDiv.appendChild(numberMark);

            // Create and append card title
            const titleEl = document.createElement('div');
            titleEl.classList.add('card-title-preview');
            titleEl.textContent = card.title.toUpperCase();
            cardDiv.appendChild(titleEl);

            // Dsiplay card details on click
            cardDiv.addEventListener('click', () => displayCardDetails(card.id));

            return cardDiv;
        }

        // Function to display card details in modal popup
        function displayCardDetails(cardId) {
            const card = cardsData.find(c => c.id === cardId);
            if (!card) return;

            const cardPreview = document.querySelector(`.card-preview[data-id="${cardId}"]`);
            const modal = document.getElementById('cardModal');

            // Fallback for browsers without view-transition support
            modal.setAttribute('data-id', card.id);
            modal.setAttribute('data-type', card.type);
            modal.setAttribute('data-suit', card.suit);
            modalType.textContent = card.type.toUpperCase();
            modalNumber.textContent = card.number.toUpperCase();
            modalSuit.textContent = suitIcons[card.suit];
            modalTitle.textContent = card.title.toUpperCase();
            modalDescription.textContent = card.description || 'not defined';

            let subtitleText = "";
            const tabs = [];
            const tabContents = [];

            if (card.type === "archetype") {
                tabs.push("Strengths", "Shadows");
                tabContents.push(
                    `<ul>${card.strengths.map(s => `<li class="editable-field" contenteditable="true" data-field="strengths">${s}</li>`).join('')}</ul>`,
                    `<ul>${card.shadows.map(s => `<li class="editable-field" contenteditable="true" data-field="shadows">${s}</li>`).join('')}</ul>`
                );
            } else if (card.type === "action") {
                tabs.push("Underplayed", "Overplayed");
                tabContents.push(
                    `<ul>${card.underplayed.map(s => `<li class="editable-field" contenteditable="true" data-field="underplayed">${s}</li>`).join('')}</ul>`,
                    `<ul>${card.overplayed.map(s => `<li class="editable-field" contenteditable="true" data-field="overplayed">${s}</li>`).join('')}</ul>`
                );
            } else if (card.type === "hero") {
                tabs.push("How it Helps", "When to Deploy");
                tabContents.push(
                    `<ul>${card.howItHelps.map(s => `<li class="editable-field" contenteditable="true" data-field="howItHelps">${s}</li>`).join('')}</ul>`,
                    `<ul>${card.whenToDeploy.map(s => `<li class="editable-field" contenteditable="true" data-field="whenToDeploy">${s}</li>`).join('')}</ul>`
                );
            }

            const tabsContainer = modalContent.querySelector('.tabs');
            const tabContentContainer = modalContent.querySelector('.tab-content');

            tabsContainer.innerHTML = '';
            tabContentContainer.innerHTML = '';

            tabs.forEach((tab, index) => {
                const tabButton = document.createElement('button');
                tabButton.classList.add('tab-button');
                tabButton.textContent = tab;
                tabButton.addEventListener('click', () => {
                    const isActive = tabButton.classList.contains('active');

                    // Deselect all tabs and hide all content
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content-item').forEach(content => content.style.display = 'none');

                    // If the clicked tab was not active, activate it and show its content
                    if (!isActive) {
                        tabButton.classList.add('active');
                        tabContentContainer.querySelector(`#tab-content-${index}`).style.display = 'block';
                    }
                });
                tabsContainer.appendChild(tabButton);

                const tabContent = document.createElement('div');
                tabContent.id = `tab-content-${index}`;
                tabContent.classList.add('tab-content-item');
                tabContent.style.display = 'none';
                tabContent.innerHTML = tabContents[index];
                tabContentContainer.appendChild(tabContent);
            });

            // Show modal
            modal.style.display = 'block';
        }

        // Modal Save button functionality
        saveButton.onclick = async () => {
            const cardId = modal.getAttribute('data-id'); // Get the card ID from the modal
            const card = cardsData.find(c => c.id === cardId); // Find the card data by ID

            if (card) {
                try {
                    let isDirty = false;

                    const editableFields = document.querySelectorAll('.editable-field');
                    editableFields.forEach(field => {
                        const fieldName = field.getAttribute('data-field');
                        const newValue = field.textContent.trim();

                        if (Array.isArray(card[fieldName])) {
                            const index = Array.from(field.parentNode.children).indexOf(field);
                            if (card[fieldName][index] !== newValue) {
                                card[fieldName][index] = newValue;
                                isDirty = true;
                            }
                        } else if (card[fieldName] !== newValue) {
                            card[fieldName] = newValue;
                            isDirty = true;

                            // Update the card preview dynamically if the title changes
                            if (fieldName === 'title') {
                                const cardPreview = document.querySelector(`.card-preview[data-id="${cardId}"] .card-title-preview`);
                                if (cardPreview) {
                                    cardPreview.textContent = newValue.toUpperCase();
                                }
                            }
                        }
                    });

                    if (isDirty) {
                        card.isModified = true; // Set the isModified flag to true
                        await saveCardToFirebase(card);

                        // Update the green tick mark dynamically
                        const cardPreview = document.querySelector(`.card-preview[data-id="${cardId}"]`);
                        if (cardPreview && !cardPreview.querySelector('.tick-mark')) {
                            const tickMark = document.createElement('div');
                            tickMark.classList.add('tick-mark'); // Use the tick-mark class for styling
                            tickMark.textContent = 'â';
                            cardPreview.appendChild(tickMark);
                        }
                    } else {
                        console.log('No changes detected, skipping save.');
                    }

                    modal.style.display = 'none';
                } catch (error) {
                    console.error('Error saving card:', error);
                }
            } else {
                console.error('Card not found.');
            }
        }

        // Modal close button functionality
        closeButton.onclick = () => {
            modal.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === "Escape" && modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });

        // Reset all cards' isModified field to false
        const resetButton = document.getElementById('reset-modified-button');
        resetButton.addEventListener('click', async () => {
            try {
                cardsData.forEach(card => {
                    card.isModified = false;
                });

                // Update Firebase
                await Promise.all(cardsData.map((card) => saveCardToFirebase(card)));

                // Remove green tick marks from all card previews
                document.querySelectorAll('.card-preview .tick-mark').forEach(tickMark => tickMark.remove());

                console.log('All modifications have been reset.');
            } catch (error) {
                console.error('Error resetting modifications:', error);
            }
        });
    });
</script>

</body>
</html>